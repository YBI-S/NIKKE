<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ⚠️ Remplace ces valeurs par les tiennes
  const supabaseUrl = 'https://ezugesmyliadzcsrumgb.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6dWdlc215bGlhZHpjc3J1bWdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3Njc0NzYsImV4cCI6MjA3OTM0MzQ3Nn0.f-Pk8gShDLwZm_WsR-CtAPAiEOBYUB7b3p4quH1YaCY';
  const supabase = createClient(supabaseUrl, supabaseKey);

  // === Fonction pour enregistrer la commande sur Supabase ===
  async function saveOrder(name, email, cart) {
    const { data, error } = await supabase
      .from('orders')
      .insert([{ name, email, cart }]);
    
    if (error) {
      console.error(error);
      alert('Erreur lors de l’enregistrement.');
    } else {
      alert('Commande enregistrée !');
    }
  }

  // === Logique du panier ===
  const cart = []; // tableau mémoire pour le panier
  const overlay = document.getElementById('overlay');
  const cartContents = document.getElementById('cart-contents');
  const checkoutBtn = document.getElementById('checkout-btn');
  const checkoutWrap = document.getElementById('checkout-form-wrap');
  const closeModalBtn = document.getElementById('close-modal');
  const viewCollectionBtn = document.getElementById('view-collection');
  const payBtn = document.getElementById('pay-btn');
  const cancelPayBtn = document.getElementById('cancel-pay');

  const formatPrice = (value) => value + '€';

  function renderCart() {
    if (cart.length === 0) {
      cartContents.textContent = 'Aucun produit dans le panier.';
      checkoutBtn.disabled = true;
      checkoutWrap.style.display = 'none';
      return;
    }

    let total = 0;
    const list = document.createElement('div');
    list.style.display = 'flex';
    list.style.flexDirection = 'column';
    list.style.gap = '8px';

    cart.forEach((item, idx) => {
      total += item.price * item.qty;
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.justifyContent = 'space-between';
      row.style.alignItems = 'center';

      const left = document.createElement('div');
      left.textContent = `${item.name} (x${item.qty})`;
      left.className = 'muted';

      const right = document.createElement('div');
      right.style.display = 'flex';
      right.style.gap = '8px';
      right.style.alignItems = 'center';

      const price = document.createElement('div');
      price.style.fontWeight = '800';
      price.textContent = formatPrice(item.price * item.qty);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'cart-btn';
      removeBtn.textContent = 'Retirer';
      removeBtn.onclick = () => {
        cart.splice(idx, 1);
        renderCart();
      };

      right.appendChild(price);
      right.appendChild(removeBtn);
      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);
    });

    const totalRow = document.createElement('div');
    totalRow.style.display = 'flex';
    totalRow.style.justifyContent = 'space-between';
    totalRow.style.marginTop = '10px';
    totalRow.style.paddingTop = '8px';
    totalRow.style.borderTop = '1px solid rgba(255,255,255,0.04)';

    const totLabel = document.createElement('div');
    totLabel.textContent = 'Total';
    totLabel.style.fontWeight = '800';

    const totValue = document.createElement('div');
    totValue.textContent = formatPrice(total);

    totalRow.appendChild(totLabel);
    totalRow.appendChild(totValue);

    cartContents.innerHTML = '';
    cartContents.appendChild(list);
    cartContents.appendChild(totalRow);

    checkoutBtn.disabled = false;
  }

  function openModal() {
    overlay.style.display = 'flex';
    overlay.setAttribute('aria-hidden', 'false');
    renderCart();
  }

  function closeModal() {
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden', 'true');
    checkoutWrap.style.display = 'none';
  }

  // Ajout au panier
  document.querySelectorAll('.buy').forEach(btn => {
    btn.addEventListener('click', () => {
      const name = btn.dataset.name || btn.getAttribute('data-name');
      const price = Number(btn.dataset.price || btn.getAttribute('data-price') || 0);
      if (!name) return;

      const existing = cart.find(i => i.name === name && i.price === price);
      if (existing) {
        existing.qty += 1;
      } else {
        cart.push({ name, price, qty: 1 });
      }

      const prev = btn.textContent;
      btn.textContent = 'Ajouté ✓';
      setTimeout(() => btn.textContent = prev, 900);
    });
  });

  // Ouverture du panier
  document.querySelectorAll('[data-view-cart]').forEach(b => {
    b.addEventListener('click', openModal);
  });

  viewCollectionBtn.addEventListener('click', () => {
    document.getElementById('products').scrollIntoView({ behavior: 'smooth' });
  });

  closeModalBtn.addEventListener('click', closeModal);

  checkoutBtn.addEventListener('click', () => {
    checkoutWrap.style.display = 'block';
    const first = document.getElementById('card-name');
    if (first) first.focus();
  });

  // Paiement et enregistrement sur Supabase
  payBtn.addEventListener('click', async () => {
    const name = document.getElementById('card-name').value.trim();
    const email = document.getElementById('billing-post').value.trim(); // ou crée un champ email dédié

    if (!name || !email || cart.length === 0) {
      alert('Veuillez remplir tous les champs et avoir au moins un produit.');
      return;
    }

    await saveOrder(name, email, cart);

    // Vider le panier
    cart.length = 0;
    renderCart();
    checkoutWrap.style.display = 'none';
    closeModal();
  });

  cancelPayBtn.addEventListener('click', () => {
    checkoutWrap.style.display = 'none';
  });

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && overlay.style.display === 'flex') closeModal();
    if (e.key.toLowerCase() === 'p' && !e.metaKey && !e.ctrlKey) openModal();
  });

  // Initial render
  renderCart();
</script>
